<html>
    <head>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
    <script src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.10.3/jquery-ui.min.js"></script>
    <link type="text/css" rel="stylesheet" href="http://ajax.googleapis.com/ajax/libs/jqueryui/1.10.3/themes/smoothness/jquery-ui.min.css" />
    
    <link rel="stylesheet" href="css/blueprint/screen.css" type="text/css" media="screen, projection">
    <link rel="stylesheet" href="css/blueprint/print.css" type="text/css" media="print"> 
    <!--[if lt IE 8]>
      <link rel="stylesheet" href="css/blueprint/ie.css" type="text/css" media="screen, projection">
    <![endif]-->

    <script>
    $(function() {
        $( "#tabs" ).tabs();
        
        init();
        
        $("#button_add_new_folder").click(function(){
            Ti.UI.currentWindow.openFolderChooserDialog(function(dir){
                if( dir.length){
                    //alert(dir[0]);
                    Ti.API.info("Adding folder:"+dir[0]);
                    var db = get_database();
                    db.execute("insert into directory values('"+dir[0]+"')");
                    db.close();
                    
                    update_folder_list();
                }
            } );        
        });
        
        $("#button_remove_folder").click(function(){
            var folder= $("#folders").val();
            if( folder){
                Ti.API.info("Removing folder:"+ folder);
                remove_folder(folder);
            }else{
                alert('Please select a folder from the list!') ;
            }
            
        });
        
        $("#button_scan_folder").click(function(){
            var folder= $("#folders").val();
            if( folder){
                Ti.API.info("Scanning folder:"+ folder);
                var worker= Ti.Worker.createWorker(scan_folder_worker);
                worker.postMessage(folder);
                worker.onmessage= function(event){
                    if( event.message.status ==1 ){
                        $("#button_scan_folder").attr("disabled","disabled");
                    } else if( event.message.status==0){
                        $("#button_scan_folder").removeAttr("disabled");     
                    }
                    $("#message").text(event.message.message);
                };
                worker.start();
                
            }else{
                alert('Please select a folder from the list!') ;
            }
        });
        
        $("#button_search_book").click(function(){
            var search_text= $("#search_text").val();
            var search_status= $("#search_status").val();
            var search_favor= $("#search_favor").val();
            
            var sql="select * from book where id>0 ";
            if(search_text.length >0 ){
                sql+=" path like '%"+search_text+"%' "
            }    
        });
    });
    
    function init(){
        //set window title
        var userwindow = Ti.UI.currentWindow;
        userwindow.setTitle("ebook manager");

        //create database if not exist
        var db = get_database();
        db.execute("create table if not exists directory( name text primary key)");  
        db.execute("create table if not exists book(id integer primary key, root text, path text, name text, extension text, status integer, isfavor integer, tags text, touch integer)"); 
        db.execute("create unique index if not exists book_index on book (path, name) " );                                        
        db.close();
        
        update_folder_list();
    }
    
    function get_database(){
        return Ti.Database.openFile(Ti.Filesystem.getFile(
                                  Ti.Filesystem.getApplicationDataDirectory(), 'ebooks.db'));
    }
    
    function update_folder_list(){
        var db = get_database();
        var rows = db.execute("select * from directory");
        $("#folders").empty();
        while( rows.isValidRow()){
            Ti.API.info("Directory:"+ rows.fieldByName("name"));
            $("#folders").append("<option>"+rows.fieldByName("name")+"</option>");            
            rows.next();
        }
        rows.close();
        db.close();
    }
    
    function remove_folder(folder){
        var db = get_database();
        db.execute("delete from directory where name='"+folder+"'");
        //remove books from the database as well
        db.execute("delete from book where root='"+folder+"'");
        
        update_folder_list();
        var notification = Ti.Notification.createNotification({
            'title' : 'Notice',
            'message' : 'Folder: '+folder+" removed",
            'timeout' : 10
            
                
        });
        
        notification.show();
    }
    
    
    
    function scan_folder_worker(){
        this.get_database= function(){
            return Ti.Database.openFile(Ti.Filesystem.getFile(
                                      Ti.Filesystem.getApplicationDataDirectory(), 'ebooks.db'));
        };
        
        this.db= this.get_database();
        this.root_folder="";
                                  
        this.onmessage= function(event){
            this.root_folder=event.message;
            Ti.API.info("Scaning:"+this.root_folder);
            this.postMessage({"status":1, "message":"Scanning "+this.root_folder});
            
            var db= this.db;
            db.execute("update book set touch=0 where root='"+this.root_folder+"'");
            
            //step 1: scan files to insert
            this.scan_folder( this.root_folder, this);
            
            //step 2: remove those books that touch=0
            db.execute("delete from book where touch=0");
                        
            this.postMessage({"status":0, "message":"Scan finished "+this.root_folder});
               
        };
        
        this.scan_folder=function(folder, parent){
            parent.postMessage({"status":2, "message":"Scanning:"+ folder});
            var ebook_extensions= "pdf,chm";
            var db= parent.db;
            var dir =  Ti.Filesystem.getFile(folder);
            var files= dir.getDirectoryListing();
            for(var i=0; i< files.length; i++ ){
                
                if( files[i].isFile()){
                    Ti.API.info("File:"+ files[i].name());
                    
                    //decide if it is a ebook: pdf, chm
                    if( ebook_extensions.indexOf( files[i].extension()) >=0){                    
                    
                        //add the file to database
                        try{
                            //find if the file already exist
                            var rows= db.execute("select id from book where path='"+folder+"' and name='"+ escape(files[i].name())+"' ");
                            if( rows.isValidRow()){
                                //existing book
                                var id= rows.fieldByName("id");
                                Ti.API.info("Exist "+id+ " "+ escape(files[i].name())); 
                                db.execute("update book set touch=1 where id="+id);
                                   
                            }else{
                                // new book
                                db.execute("insert into book(root, path, name, extension, status, isfavor, touch) values('"+parent.root_folder+"', '"+folder+"','"+ escape(files[i].name())+"', '"+files[i].extension()+"', 0, 0, 1)");
                            }
                        }catch(err){
                            Ti.API.error( err);
                        }
                    }
                    
                }else if( files[i].isDirectory()){
                    Ti.API.info("Dir:"+files[i]);
                    parent.scan_folder( files[i].nativePath(), parent);
                }
                
            }
        };
        
    }
    
    function scan_folder(folder){
        Ti.API.info( folder);
        var dir =  Ti.Filesystem.getFile(folder);
        var files= dir.getDirectoryListing();
        for(var i=0; i< files.length; i++ ){
            Ti.API.info( files[i]);
        }
    }
    
    </script>
    </head>
    <body >
        <div id="tabs">
            <ul>
            <li><a href="#tabs-1">Books</a></li>
            <li><a href="#tabs-2">Settings</a></li>
            </ul>
            <div id="tabs-1">
                <div class="container" style="width:780px" >
                    <div class="span-15 last">
                        <input id='search_text' size=20 />
                        Status:<select id="search_status">
                            <option>Select...</option>
                            <option value='1'>Reading</option>
                            <option value='2'>Read</option>
                            <option value='3'>Going to Read</option>
                        </select>
                        Favor:<input type='checkbox' id="search_favor" >
                        <input type='button' id='button_search_book' value="Search">
                    </div>            
                </div>
            </div>
            <div id="tabs-2">
                <div class="container" style="width:780px" >
                    <div class="span-10 border">
                        <select id="folders" class="span-9" size=10></select>
                    </div>
                    <div class="span-5 last">
                        <table style="height:150px">
                        <tr><td><input type='button' id="button_remove_folder" value='Remove Folder'></td></tr>
                        <tr><td><input type='button' id="button_scan_folder" value='Scan Folder'></td></tr>
                        
                        </table>
                    </div>
                    
                    <div class="span-15 last">
                        <input type='button' id="button_add_new_folder" value="Add New Folder">
                    </div>
                    <div class="span-15 last">
                        Message:<span id="message" ></span>
                    </div>
                </div>                
            </div>
        </div>    
    </body>
</html>